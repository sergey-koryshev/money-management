name: Increment version for 'Backend'

concurrency: versioning

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - source/backend/**

jobs:
  create_label:
    name: Increment version
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    env:
      ROOT_PATH: source/backend
      PRODUCT_VERSION_FILE: version.json
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}

      - name: Increment Version
        uses: sergey-koryshev/bump-version@v1.0.4
        with:
          app-name: backend
          root-path: ${{ env.ROOT_PATH }}
          project-type: Custom
          posh-custom-module-path: build/WebApiIncrementVersionHelper.psm1
          version-configuration-path: ${{ env.ROOT_PATH }}/version-configuration.json

      - name: Propagate DEV product version to backend
        shell: pwsh
        run: |
          . build/PropagateBackendProductVersion.ps1 -ProjectRootPath $env:ROOT_PATH -ProductVersionFile $env:PRODUCT_VERSION_FILE
